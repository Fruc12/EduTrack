{% extends "layouts/base.html" %}

{% block title %} Tableau de Bord Parent {% endblock %}

{% block content %}
<div class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- [ breadcrumb ] start -->
        <div class="page-header">
            <div class="page-block">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <div class="page-header-title">
                            <h5 class="m-b-10">Suivi Scolaire - Parent</h5>
                        </div>
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="#!">Tableau de Bord</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ breadcrumb ] end -->

        <!-- [ Main Content ] start -->
        <div class="row">
            <!-- Carte Enfants -->
            <div class="col-md-6 col-xl-3">
                <div class="card flat-card widget-primary-card">
                    <div class="row-table">
                        <div class="col-sm-3 card-body">
                            <i class="feather icon-users text-c-blue"></i>
                        </div>
                        <div class="col-sm-9">
                            <h4>{{ enfants.count }}</h4>
                            <h6>Enfant(s) inscrit(s)</h6>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carte Devoirs -->
            <div class="col-md-6 col-xl-3">
                <div class="card flat-card widget-warning-card">
                    <div class="row-table">
                        <div class="col-sm-3 card-body">
                            <i class="feather icon-book text-c-yellow"></i>
                        </div>
                        <div class="col-sm-9">
                            <h4>{{ devoirs.count }}</h4>
                            <h6>Devoirs en cours</h6>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carte Notes -->
            <div class="col-md-6 col-xl-3">
                <div class="card flat-card widget-success-card">
                    <div class="row-table">
                        <div class="col-sm-3 card-body">
                            <i class="feather icon-file-text text-c-green"></i>
                        </div>
                        <div class="col-sm-9">
                            <h4>{{ bulletins.count }}</h4>
                            <h6>Bulletins disponibles</h6>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carte Absences -->
            <div class="col-md-6 col-xl-3">
                <div class="card flat-card widget-danger-card">
                    <div class="row-table">
                        <div class="col-sm-3 card-body">
                            <i class="feather icon-alert-triangle text-c-red"></i>
                        </div>
                        <div class="col-sm-9">
                            <h4>{{ absences.count }}</h4>
                            <h6>Absences</h6>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Enfants -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Mes Enfants</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for enfant in enfants %}
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body text-center">
                                        <img src="{{ enfant.photo.url }}" alt="{{ enfant.nom }}" class="img-fluid rounded-circle mb-3" width="100">
                                        <h5>{{ enfant.nom_complet }}</h5>
                                        <p class="text-muted">{{ enfant.classe.nom }}</p>
                                        <a href="{% url 'enfant_detail' enfant.id %}" class="btn btn-primary btn-sm">
                                            Voir le détail
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emploi du temps -->
            <div class="col-md-12 col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Emploi du temps</h5>
                        <div class="card-header-right">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary">Semaine actuelle</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Jour</th>
                                        <th>Matière</th>
                                        <th>Heure</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for emploi in emplois_du_temps %}
                                    <tr>
                                        <td>{{ emploi.jour }}</td>
                                        <td>{{ emploi.matiere }}</td>
                                        <td>{{ emploi.heure_debut|time:"H:i" }} - {{ emploi.heure_fin|time:"H:i" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Devoirs à venir -->
            <div class="col-md-12 col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Devoirs à rendre</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            {% for devoir in devoirs %}
                            <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ devoir.matiere }}</h6>
                                    <small class="text-{% if devoir.est_en_retard %}danger{% else %}muted{% endif %}">
                                        Pour le {{ devoir.date_rendu|date:"d/m/Y" }}
                                    </small>
                                </div>
                                <p class="mb-1">{{ devoir.description|truncatechars:50 }}</p>
                                <small>{{ devoir.enfant.nom }}</small>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dernières notes -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Dernières notes</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Matière</th>
                                        <th>Note</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Enfant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for note in notes %}
                                    <tr>
                                        <td>{{ note.matiere }}</td>
                                        <td>
                                            <span class="badge badge-{% if note.valeur >= 12 %}success{% else %}warning{% endif %}">
                                                {{ note.valeur }}/20
                                            </span>
                                        </td>
                                        <td>{{ note.type_note }}</td>
                                        <td>{{ note.date|date:"d/m/Y" }}</td>
                                        <td>{{ note.enfant.nom }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ Main Content ] end -->
    </div>
</div>
{% endblock %}

{% block javascripts %}
<!-- Apex Chart -->
<script src="/static/assets/js/plugins/apexcharts.min.js"></script>

<!-- Données injectées de manière sécurisée -->
{{ moyennes|json_script:"moyennes-data" }}
{{ matieres|json_script:"matieres-data" }}

<!-- custom-chart js -->
<script>
    // Graphique de progression des notes
    const moyennes = JSON.parse(document.getElementById("moyennes-data").textContent);
    const matieres = JSON.parse(document.getElementById("matieres-data").textContent);

    var options = {
        chart: {
            height: 350,
            type: 'line',
        },
        series: [{
            name: "Moyenne",
            data: moyennes
        }],
        xaxis: {
            categories: matieres
        },
        stroke: {
            curve: 'smooth'
        },
        markers: {
            size: 5,
            colors: ['#fff'],
            strokeColors: '#000',
            strokeWidth: 2,
            hover: {
                size: 7
            }
        },
        colors: ['#1E90FF'],
        grid: {
            borderColor: '#e7e7e7',
            row: {
                colors: ['#f3f3f3', 'transparent'],
                opacity: 0.5
            },
        },
        tooltip: {
            theme: 'dark',
            y: {
                formatter: function (val) {
                    return val + " points";
                }
            }
        }
    };

    var chart = new ApexCharts(document.querySelector("#notes-chart"), options);
    chart.render();
</script>

{% endblock %}